<div class="asset-detail-page">
  <div class="page-header-top">
    <div class="asset-title-section">
      <h1 class="asset-title">
        {{ currentSymbol() || 'Asset Details' }}
        <span class="asset-name-light" *ngIf="assetName">{{ assetName }}</span>
      </h1>
      <div class="asset-price">
        <ng-container *ngIf="currentPrice() && !isLoading()">
          <span class="price-value">${{ currentPrice()?.price | number:'1.2-4' }}</span>
          <span class="price-currency">USD</span>
        </ng-container>
        <ng-container *ngIf="isLoading()">
          <div class="spinner spinner-inline"></div>
        </ng-container>
      </div>
    </div>

    <div class="back-link-wrapper">
      <a routerLink="/market" class="back-link">
        <span class="back-arrow">←</span> Zurück zur Marktübersicht
      </a>
    </div>
  </div>

  <div class="asset-hint" [class.asset-hint--warning]="!isMarketOpen">
    <span class="info-icon">i</span>
    <div class="hint-content">
      <div class="hint-main">
        Der Chart zeigt die Preisentwicklung der letzten 6 Stunden. Preise werden minütlich aktualisiert.
      </div>
      <div class="hint-market-status" *ngIf="!isMarketOpen && marketStatusText">
        {{ marketStatusText }}
      </div>
    </div>
  </div>

  <app-minute-chart
    [chartData]="chartData()"
    [loading]="chartLoading()"
    [isMarketOpen]="isMarketOpen"></app-minute-chart>

  <div class="portfolio-grid">
    <div class="portfolio-card balance-card">
      <div class="balance-header">
        <h2 class="card-title">Verfügbares Guthaben</h2>
      </div>
      <div class="balance-body">
        <div class="balance-amount">
          <ng-container *ngIf="!balanceLoading">
            {{ '$' + (walletBalance | number:'1.2-2') }} USD
          </ng-container>
          <ng-container *ngIf="balanceLoading">
            <div class="spinner"></div>
          </ng-container>
        </div>
      </div>
    </div>
  </div>

  <!-- Trade Message moved here - above the trade card -->
  <div *ngIf="tradeMessage" class="trade-message" [class.trade-message--success]="tradeMessageType === 'success'" [class.trade-message--error]="tradeMessageType === 'error'">
    <span class="message-icon">{{ tradeMessageType === 'success' ? '✓' : '✕' }}</span>
    <span class="message-text">{{ tradeMessage }}</span>
  </div>

  <div class="portfolio-card trade-card">
    <h2 class="card-title">Asset kaufen</h2>

    <div class="buy-mode-toggle">
      <button
        type="button"
        class="mode-btn"
        [class.active]="buyMode === 'quantity'"
        (click)="buyMode = 'quantity'">
        Nach Menge
      </button>
      <button
        type="button"
        class="mode-btn"
        [class.active]="buyMode === 'usd'"
        (click)="buyMode = 'usd'">
        Nach USD-Betrag
      </button>
    </div>

    <div class="trade-input-section">
      <ng-container *ngIf="buyMode === 'quantity'">
        <label class="input-label">Menge ({{ currentSymbol() }})</label>
        <input
          type="number"
          class="form-control trade-input"
          [(ngModel)]="quantity"
          [step]="minTradeIncrement"
          [min]="minTradeIncrement"
          placeholder="0.0000" />
        <div class="input-hint">
          Mindestmenge: {{ minTradeIncrement }} {{ currentSymbol() }}
        </div>
      </ng-container>

      <ng-container *ngIf="buyMode === 'usd'">
        <label class="input-label">USD-Betrag</label>
        <input
          type="number"
          class="form-control trade-input"
          [(ngModel)]="usdAmount"
          min="1"
          step="1"
          placeholder="0.00" />
        <div *ngIf="calculatedQuantity" class="calculated-info">
          ≈ {{ calculatedQuantity | number:'1.4-4' }} {{ currentSymbol() }}
        </div>
        <div *ngIf="usdAmount && !calculatedQuantity" class="input-hint input-hint--warning">
          Der eingegebene Betrag ist zu gering für eine gültige Kaufmenge.
        </div>
      </ng-container>
    </div>

    <div class="trade-preview" *ngIf="calculatedQuantity && currentPrice()">
      <div class="preview-row">
        <span class="preview-label">Menge:</span>
        <span class="preview-value">{{ calculatedQuantity | number:'1.4-4' }} {{ currentSymbol() }}</span>
      </div>
      <div class="preview-row">
        <span class="preview-label">Preis pro Stück:</span>
        <span class="preview-value">${{ currentPrice()?.price | number:'1.2-4' }} USD</span>
      </div>
      <div class="preview-row preview-row-total">
        <span class="preview-label">Gesamtkosten:</span>
        <span class="preview-value-large">${{ (calculatedQuantity * currentPrice()!.price) | number:'1.2-2' }} USD</span>
      </div>
    </div>

    <button
      type="button"
      class="btn btn-primary btn-trade"
      (click)="buyAsset()"
      [disabled]="buying || !calculatedQuantity">
      <ng-container *ngIf="!buying">Kaufen</ng-container>
      <ng-container *ngIf="buying">
        <div class="spinner spinner-inline"></div>
        Wird gekauft...
      </ng-container>
    </button>
  </div>
</div>
