<div class="portfolio-page">
  <h1 class="portfolio-title">Portfolio</h1>

  <div class="portfolio-hint">
    <span class="info-icon">i</span>
    Übersicht über dein aktuelles Demo-Portfolio. Werte werden live aus den Marktdaten ermittelt.
  </div>

  <div *ngIf="error" class="alert alert-danger">
    {{ error }}
  </div>

  <div class="portfolio-grid">
    <div class="portfolio-card balance-card">
      <div class="balance-header">
        <h2 class="card-title">Verfügbares Guthaben</h2>
        <button type="button" class="btn btn-primary btn-sm" (click)="openAddFundsModal()">
          Guthaben aufladen
        </button>
      </div>
      <div class="balance-body">
        <div class="balance-info">
          <div class="balance-amount">
            <ng-container *ngIf="!balanceLoading; else balanceSpinner">
              {{ '$' + (walletBalance | number:'1.2-2') }} USD
            </ng-container>
            <ng-template #balanceSpinner>
              <div class="spinner"></div>
            </ng-template>
          </div>
        </div>
      </div>
    </div>

    <div class="portfolio-card summary-card" *ngIf="!isLoading && heldTrades.length === 0">
      <h2 class="card-title">Keine gehaltenen Assets</h2>
      <p class="empty-text">
        Kaufe im Markt ein Asset, damit es hier erscheint.
      </p>
    </div>
  </div>

  <div *ngIf="isLoading" class="loading-block">
    <div class="spinner"></div>
    <p>Portfolio wird geladen…</p>
  </div>

  <div class="portfolio-table-wrapper" *ngIf="!isLoading && heldTrades.length > 0">
    <div class="portfolio-card">
      <h2 class="card-title table-title">Gehaltene Assets</h2>
      <div class="table-scroller">
        <table class="portfolio-table">
          <thead>
          <tr>
            <th>Asset</th>
            <th>Symbol</th>
            <th class="th-num">Menge</th>
            <th class="th-num th-multiline">Kaufpreis<br>/Stk.</th>
            <th class="th-num th-multiline">Gesamtkauf-<br>preis</th>
            <th class="th-num th-multiline">Aktueller<br>Preis/Stk.</th>
            <th class="th-num th-multiline">Aktueller<br>Gesamtwert</th>
            <th>Kaufdatum</th>
            <th class="th-num">Gewinn / Verlust</th>
            <th class="th-actions">Aktionen</th>
          </tr>
          </thead>
          <tbody>
          <ng-container *ngFor="let trade of heldTrades">
            <tr class="portfolio-row">
              <td class="asset-cell">
                {{ trade.assetName || '—' }}
              </td>

              <td class="symbol-cell">
                <span class="asset-badge">{{ trade.assetSymbol }}</span>
              </td>

              <td class="td-num">{{ trade.quantity | number:'1.2-4' }}</td>

              <td class="td-num">{{ trade.buyPriceUsd | number:'1.2-2' }}</td>

              <td class="td-num">{{ getTotalBuyPrice(trade) | number:'1.2-2' }}</td>

              <td class="td-num">
                <ng-container *ngIf="trade.currentPriceUsd; else priceLoading">
                  {{ trade.currentPriceUsd | number:'1.2-2' }}
                </ng-container>
                <ng-template #priceLoading>
                  <span class="muted">—</span>
                </ng-template>
              </td>

              <td class="td-num">
                <ng-container *ngIf="trade.currentPriceUsd">
                  {{ getCurrentTotalValue(trade) | number:'1.2-2' }}
                </ng-container>
                <ng-container *ngIf="!trade.currentPriceUsd">
                  <span class="muted">—</span>
                </ng-container>
              </td>

              <td class="td-date">{{ trade.createdAt | date:'short' }}</td>

              <td class="td-num">
                <ng-container *ngIf="trade.currentPriceUsd">
                  <span
                    class="gain-badge"
                    [ngClass]="{
                      'gain-badge--up': getTotalProfitLoss(trade) > 0,
                      'gain-badge--down': getTotalProfitLoss(trade) < 0,
                      'gain-badge--neutral': getTotalProfitLoss(trade) === 0
                    }"
                  >
                    <span class="arrow" *ngIf="getTotalProfitLoss(trade) > 0">▲</span>
                    <span class="arrow" *ngIf="getTotalProfitLoss(trade) < 0">▼</span>
                    {{ getTotalProfitLoss(trade) | number:'1.2-2' }} USD
                    ({{ (getTotalProfitLoss(trade) / getTotalBuyPrice(trade) * 100) | number:'1.2-2' }}%)
                  </span>
                </ng-container>
              </td>

              <!-- Aktionen -->
              <td class="td-actions">
                <button
                  class="btn btn-primary btn-sm"
                  (click)="openSellModal(trade)"
                >
                  Verkaufen
                </button>
              </td>
            </tr>
          </ng-container>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Add Funds Modal -->
  <div *ngIf="showAddFundsModal" class="modal-overlay" (click)="closeAddFundsModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3 class="modal-title">Guthaben aufladen</h3>
        <button class="modal-close" (click)="closeAddFundsModal()">×</button>
      </div>
      <div class="modal-body">
        <div class="modal-hint">
          <span class="info-icon small">i</span>
          Demo-Broker: Ziel ist der Umgang mit begrenztem Kapital. Lade nur auf, wenn du es wirklich für einen Trade brauchst.
        </div>

        <div class="quick-amounts">
          <button type="button" class="chip" (click)="setAddFundsAmount(50)">50</button>
          <button type="button" class="chip" (click)="setAddFundsAmount(100)">100</button>
          <button type="button" class="chip" (click)="setAddFundsAmount(250)">250</button>
          <button type="button" class="chip" (click)="setAddFundsAmount(500)">500</button>
          <button type="button" class="chip" (click)="setAddFundsAmount(1000)">1000</button>
          <button type="button" class="chip" (click)="setAddFundsAmount(2500)">2500</button>
          <button type="button" class="chip" (click)="setAddFundsAmount(5000)">5000</button>
          <button type="button" class="chip" (click)="setAddFundsAmount(7500)">7500</button>
          <button type="button" class="chip" (click)="setAddFundsAmount(10000)">10000</button>
        </div>

        <label class="modal-label" for="amountInput">Betrag ({{ addFundsMin }} – {{ addFundsMax }} USD)</label>
        <input
          id="amountInput"
          type="number"
          class="form-control"
          [ngModel]="addFundsAmount"
          (ngModelChange)="onAddFundsAmountChange($event)"
          [min]="addFundsMin"
          [max]="addFundsMax"
          step="1"
          placeholder="z. B. 150"
        />

        <input
          type="range"
          class="range-input"
          [min]="addFundsMin"
          [max]="addFundsMax"
          [step]="1"
          [ngModel]="addFundsAmount"
          (ngModelChange)="onAddFundsAmountChange($event)"
        />

        <div *ngIf="addFundsError" class="modal-error">
          {{ addFundsError }}
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" type="button" (click)="closeAddFundsModal()">Abbrechen</button>
        <button
          class="btn btn-primary"
          type="button"
          [disabled]="!canSubmitAddFunds()"
          (click)="addFunds()"
        >
          {{ addingFunds ? 'Wird hinzugefügt…' : 'Aufladen' }}
        </button>
      </div>
    </div>
  </div>

  <!-- Sell Asset Modal -->
  <div *ngIf="showSellModal" class="modal-overlay" (click)="closeSellModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3 class="modal-title">{{ selectedTrade?.assetSymbol }} verkaufen</h3>
        <button class="modal-close" (click)="closeSellModal()">×</button>
      </div>
      <div class="modal-body">
        <div class="modal-hint">
          <span class="info-icon small">i</span>
          Verfügbare Menge: {{ selectedTrade?.quantity | number:'1.2-4' }} {{ selectedTrade?.assetSymbol }}
        </div>

        <!-- Asset Info -->
        <div class="asset-info-box">
          <div class="info-row">
            <span class="info-label">Asset:</span>
            <span class="info-value">{{ selectedTrade?.assetName || '—' }}</span>
          </div>
          <div class="info-row">
            <span class="info-label">Kaufpreis/Stk.:</span>
            <span class="info-value">{{ selectedTrade?.buyPriceUsd | number:'1.2-2' }} USD</span>
          </div>
          <div class="info-row">
            <span class="info-label">Aktueller Preis/Stk.:</span>
            <span class="info-value">{{ selectedTrade?.currentPriceUsd | number:'1.2-2' }} USD</span>
          </div>
        </div>

        <!-- Quick Amounts (Prozentuale Auswahl) -->
        <div class="quick-amounts">
          <button type="button" class="chip" (click)="setSellPercentage(25)">25%</button>
          <button type="button" class="chip" (click)="setSellPercentage(50)">50%</button>
          <button type="button" class="chip" (click)="setSellPercentage(75)">75%</button>
          <button type="button" class="chip" (click)="setSellPercentage(100)">100%</button>
        </div>

        <label class="modal-label" for="sellQuantityInput">Verkaufsmenge</label>

        <!-- Quantity Controls (wie beim Add Funds die chips) -->
        <div class="quantity-controls-modal">
          <button
            class="qty-btn-modal qty-btn-dec"
            (click)="decrementSellQuantity()"
            [disabled]="!sellQuantity || sellQuantity <= 0"
          >
            −
          </button>
          <input
            id="sellQuantityInput"
            type="number"
            class="form-control"
            [(ngModel)]="sellQuantity"
            (ngModelChange)="onSellQuantityChange()"
            [min]="0"
            [max]="selectedTrade?.quantity ?? 0"
            step="any"
            placeholder="0"
          />
          <button
            class="qty-btn-modal qty-btn-inc"
            (click)="incrementSellQuantity()"
            [disabled]="(sellQuantity ?? 0) >= (selectedTrade?.quantity ?? 0)"
          >
            +
          </button>
        </div>

        <!-- Range Slider -->
        <input
          type="range"
          class="range-input"
          [min]="0"
          [max]="selectedTrade?.quantity ?? 0"
          [step]="getIncrementStep(selectedTrade?.quantity ?? 0)"
          [(ngModel)]="sellQuantity"
          (ngModelChange)="onSellQuantityChange()"
        />

        <!-- Verkaufsvorschau -->
        <div *ngIf="sellQuantity && sellQuantity > 0 && selectedTrade" class="sell-preview-box">
          <div class="preview-title">Verkaufsvorschau:</div>

          <div class="preview-calculation">
            <span class="preview-math">
              ({{ sellQuantity | number:'1.2-4' }} × {{ selectedTrade.currentPriceUsd | number:'1.2-2' }} USD)
              −
              ({{ sellQuantity | number:'1.2-4' }} × {{ selectedTrade.buyPriceUsd | number:'1.2-2' }} USD)
              =
            </span>
          </div>

          <div
            class="preview-result-large"
            [ngClass]="{
              'preview-result--pos': getSellPreviewProfitLoss() > 0.001,
              'preview-result--neg': getSellPreviewProfitLoss() < -0.001,
              'preview-result--zero': Math.abs(getSellPreviewProfitLoss()) <= 0.001
            }"
          >
            <ng-container *ngIf="getSellPreviewProfitLoss() > 0.001">
              Gewinn: +{{ getSellPreviewProfitLoss() | number:'1.2-2' }} USD
            </ng-container>
            <ng-container *ngIf="getSellPreviewProfitLoss() < -0.001">
              Verlust: {{ getSellPreviewProfitLoss() | number:'1.2-2' }} USD
            </ng-container>
            <ng-container *ngIf="Math.abs(getSellPreviewProfitLoss()) <= 0.001">
              ±0.00 USD
            </ng-container>
          </div>

          <div class="preview-total">
            Erhältst du: {{ getSellTotalValue() | number:'1.2-2' }} USD
          </div>
        </div>

        <div *ngIf="sellError" class="modal-error">
          {{ sellError }}
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" type="button" (click)="closeSellModal()">Abbrechen</button>
        <button
          class="btn btn-primary"
          type="button"
          [disabled]="!canSubmitSell()"
          (click)="confirmSell()"
        >
          {{ isSelling ? 'Wird verkauft…' : 'Verkaufen' }}
        </button>
      </div>
    </div>
  </div>
</div>
