<div class="portfolio-page">
  <h1 class="portfolio-title">Portfolio</h1>

  <div class="portfolio-hint">
    <span class="info-icon">i</span>
    Übersicht über dein aktuelles Demo-Portfolio. Werte werden live aus den Marktdaten ermittelt.
  </div>

  <div *ngIf="error" class="alert alert-danger">
    {{ error }}
  </div>

  <div class="portfolio-grid">
    <div class="portfolio-card balance-card">
      <div class="balance-header">
        <h2 class="card-title">Verfügbares Guthaben</h2>
        <button type="button" class="btn btn-primary btn-sm" (click)="openAddFundsModal()">
          Guthaben aufladen
        </button>
      </div>
      <div class="balance-body">
        <div class="balance-info">
          <div class="balance-amount">
            <ng-container *ngIf="!balanceLoading; else balanceSpinner">
              {{ '$' + (walletBalance | number:'1.2-2') }} USD
            </ng-container>
            <ng-template #balanceSpinner>
              <div class="spinner"></div>
            </ng-template>
          </div>
        </div>
      </div>
    </div>

    <div class="portfolio-card summary-card" *ngIf="!isLoading && heldTrades.length === 0">
      <h2 class="card-title">Keine gehaltenen Assets</h2>
      <p class="empty-text">
        Kaufe im Markt ein Asset, damit es hier erscheint.
      </p>
    </div>
  </div>

  <div *ngIf="isLoading" class="loading-block">
    <div class="spinner"></div>
    <p>Portfolio wird geladen…</p>
  </div>

  <div class="portfolio-table-wrapper" *ngIf="!isLoading && heldTrades.length > 0">
    <div class="portfolio-card">
      <h2 class="card-title table-title">Gehaltene Assets</h2>
      <div class="table-scroller">
        <table class="portfolio-table">
          <thead>
          <tr>
            <th>Asset</th>
            <th>Symbol</th>
            <th class="th-num">Menge</th>
            <th class="th-num">Kaufpreis/Stk.</th>
            <th class="th-num">Gesamtkaufpreis</th>
            <th class="th-num">Aktueller Preis/Stk.</th>
            <th class="th-num">Aktueller Gesamtwert</th>
            <th>Kaufdatum</th>
            <th class="th-num">Gewinn / Verlust</th>
            <th class="th-num">Verkaufsmenge</th>
            <th class="th-actions">Aktionen</th>
          </tr>
          </thead>
          <tbody>
          <ng-container *ngFor="let trade of heldTrades">
            <tr class="portfolio-row">
              <!-- Asset Name -->
              <td class="asset-cell">
                {{ trade.assetName || '—' }}
              </td>

              <!-- Symbol -->
              <td class="symbol-cell">
                <span class="asset-badge">{{ trade.assetSymbol }}</span>
              </td>

              <!-- Menge -->
              <td class="td-num">{{ trade.quantity | number:'1.2-4' }}</td>

              <!-- Kaufpreis pro Stück -->
              <td class="td-num">{{ trade.buyPriceUsd | number:'1.2-2' }}</td>

              <!-- Gesamtkaufpreis -->
              <td class="td-num">{{ getTotalBuyPrice(trade) | number:'1.2-2' }}</td>

              <!-- Aktueller Preis pro Stück -->
              <td class="td-num">
                <ng-container *ngIf="trade.currentPriceUsd; else priceLoading">
                  {{ trade.currentPriceUsd | number:'1.2-2' }}
                </ng-container>
                <ng-template #priceLoading>
                  <span class="muted">—</span>
                </ng-template>
              </td>

              <!-- Aktueller Gesamtwert -->
              <td class="td-num">
                <ng-container *ngIf="trade.currentPriceUsd">
                  {{ getCurrentTotalValue(trade) | number:'1.2-2' }}
                </ng-container>
                <ng-container *ngIf="!trade.currentPriceUsd">
                  <span class="muted">—</span>
                </ng-container>
              </td>

              <!-- Kaufdatum -->
              <td class="td-date">{{ trade.createdAt | date:'short' }}</td>

              <!-- Gewinn/Verlust Gesamt -->
              <td class="td-num">
                <ng-container *ngIf="trade.currentPriceUsd">
                  <span
                    class="gain-badge"
                    [ngClass]="{
                      'gain-badge--up': getTotalProfitLoss(trade) > 0,
                      'gain-badge--down': getTotalProfitLoss(trade) < 0,
                      'gain-badge--neutral': getTotalProfitLoss(trade) === 0
                    }"
                  >
                    <span class="arrow" *ngIf="getTotalProfitLoss(trade) > 0">▲</span>
                    <span class="arrow" *ngIf="getTotalProfitLoss(trade) < 0">▼</span>
                    {{ getTotalProfitLoss(trade) | number:'1.2-2' }} USD
                    ({{ (getTotalProfitLoss(trade) / getTotalBuyPrice(trade) * 100) | number:'1.2-2' }}%)
                  </span>
                </ng-container>
              </td>

              <!-- Verkaufsmenge Input -->
              <td class="td-num">
                <div class="quantity-controls">
                  <button
                    class="qty-btn qty-btn-dec"
                    (click)="decrementSellQuantity(trade)"
                    [disabled]="!trade.sellQuantity || trade.sellQuantity <= 0"
                  >
                    −
                  </button>
                  <input
                    type="number"
                    min="0"
                    step="any"
                    [(ngModel)]="trade.sellQuantity"
                    (ngModelChange)="onSellQuantityChange(trade)"
                    [max]="trade.quantity"
                    class="form-control quantity-input-new"
                    placeholder="0"
                  />
                  <button
                    class="qty-btn qty-btn-inc"
                    (click)="incrementSellQuantity(trade)"
                    [disabled]="trade.sellQuantity >= trade.quantity"
                  >
                    +
                  </button>
                </div>
              </td>

              <!-- Aktionen -->
              <td class="td-actions">
                <button
                  class="btn btn-primary btn-sm"
                  [disabled]="!isValidSellAmount(trade) || trade.isSelling"
                  (click)="sell(trade)"
                >
                  <ng-container *ngIf="!trade.isSelling">Verkaufen</ng-container>
                  <ng-container *ngIf="trade.isSelling">
                    <div class="spinner spinner--inline"></div>
                  </ng-container>
                </button>
              </td>
            </tr>

            <!-- Verkaufsvorschau -->
            <tr
              *ngIf="trade.currentPriceUsd && trade.sellQuantity && trade.sellQuantity > 0"
              class="portfolio-row-details"
            >
              <td colspan="11">
                <div class="sell-preview-row">
                  <span class="preview-label">Verkaufsvorschau:</span>

                  <span class="preview-math">
                    ({{ trade.sellQuantity }} × {{ trade.currentPriceUsd | number:'1.2-2' }} USD)
                    −
                    ({{ trade.sellQuantity }} × {{ trade.buyPriceUsd | number:'1.2-2' }} USD)
                    =
                  </span>

                  <ng-container
                    *ngIf="trade.currentPriceUsd - trade.buyPriceUsd as diff"
                  >
                    <span
                      class="preview-result"
                      [ngClass]="{
                        'preview-result--pos': (diff * trade.sellQuantity) > 0,
                        'preview-result--neg': (diff * trade.sellQuantity) < 0,
                        'preview-result--zero': (diff * trade.sellQuantity) === 0
                      }"
                    >
                      <ng-container *ngIf="(diff * trade.sellQuantity) > 0">
                        Gewinn +{{ (diff * trade.sellQuantity) | number:'1.2-2' }} USD
                      </ng-container>
                      <ng-container *ngIf="(diff * trade.sellQuantity) < 0">
                        Verlust {{ (diff * trade.sellQuantity) | number:'1.2-2' }} USD
                      </ng-container>
                      <ng-container *ngIf="(diff * trade.sellQuantity) === 0">
                        ±0.00 USD
                      </ng-container>
                    </span>
                  </ng-container>
                </div>
              </td>
            </tr>
          </ng-container>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Add Funds Modal -->
  <div *ngIf="showAddFundsModal" class="modal-overlay" (click)="closeAddFundsModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3 class="modal-title">Guthaben aufladen</h3>
        <button class="modal-close" (click)="closeAddFundsModal()">×</button>
      </div>
      <div class="modal-body">
        <div class="modal-hint">
          <span class="info-icon small">i</span>
          Demo-Broker: Ziel ist der Umgang mit begrenztem Kapital. Lade nur auf, wenn du es wirklich für einen Trade brauchst.
        </div>

        <div class="quick-amounts">
          <button type="button" class="chip" (click)="setAddFundsAmount(50)">50</button>
          <button type="button" class="chip" (click)="setAddFundsAmount(100)">100</button>
          <button type="button" class="chip" (click)="setAddFundsAmount(250)">250</button>
          <button type="button" class="chip" (click)="setAddFundsAmount(500)">500</button>
          <button type="button" class="chip" (click)="setAddFundsAmount(1000)">1000</button>
          <button type="button" class="chip" (click)="setAddFundsAmount(2500)">2500</button>
          <button type="button" class="chip" (click)="setAddFundsAmount(5000)">5000</button>
          <button type="button" class="chip" (click)="setAddFundsAmount(7500)">7500</button>
          <button type="button" class="chip" (click)="setAddFundsAmount(10000)">10000</button>
        </div>

        <label class="modal-label" for="amountInput">Betrag ({{ addFundsMin }} – {{ addFundsMax }} USD)</label>
        <input
          id="amountInput"
          type="number"
          class="form-control"
          [ngModel]="addFundsAmount"
          (ngModelChange)="onAddFundsAmountChange($event)"
          [min]="addFundsMin"
          [max]="addFundsMax"
          step="1"
          placeholder="z. B. 150"
        />

        <input
          type="range"
          class="range-input"
          [min]="addFundsMin"
          [max]="addFundsMax"
          [step]="1"
          [ngModel]="addFundsAmount"
          (ngModelChange)="onAddFundsAmountChange($event)"
        />

        <div *ngIf="addFundsError" class="modal-error">
          {{ addFundsError }}
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" type="button" (click)="closeAddFundsModal()">Abbrechen</button>
        <button
          class="btn btn-primary"
          type="button"
          [disabled]="!canSubmitAddFunds()"
          (click)="addFunds()"
        >
          {{ addingFunds ? 'Wird hinzugefügt…' : 'Aufladen' }}
        </button>
      </div>
    </div>
  </div>
</div>
