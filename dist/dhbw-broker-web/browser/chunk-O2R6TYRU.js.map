{
  "version": 3,
  "sources": ["src/environments/environments.ts", "src/app/core/auth/auth.service.ts"],
  "sourcesContent": ["export const environment = {\n  production: false,\n  apiBaseUrl: 'https://rocky-atoll-88358-b10b362cee67.herokuapp.com', // Heroku BFF Backend\n};\n", "// src/app/core/auth/auth.service.ts\nimport { Injectable, computed, signal, inject } from '@angular/core';\nimport { HttpClient, HttpHeaders } from '@angular/common/http';\nimport { Observable, catchError, throwError, map, switchMap, defer } from 'rxjs';\nimport { TokenStorageService, DevJwtPayload } from './token-storage.service';\nimport { environment } from '../../../environments/environments';\n\n// Authentication models matching backend DTOs\nexport interface SignInInput {\n  email: string;\n  password: string;\n}\n\nexport interface SignUpInput {\n  email: string;\n  password: string;\n  firstName: string;\n  lastName: string;\n}\n\nexport interface JwtAuthResponse {\n  accessToken: string;\n  tokenType: string;\n  expiresAt: string; // ISO string format from backend\n}\n\nexport interface AuthUser {\n  id: string;\n  email: string;\n  firstName?: string;\n  lastName?: string;\n  roles: string[];\n  exp: number;\n}\n\ninterface QueuedRequest {\n  credentials: SignInInput;\n  resolve: (value: JwtAuthResponse) => void;\n  reject: (error: any) => void;\n}\n\n@Injectable({ providedIn: 'root' })\nexport class AuthService {\n  private readonly http = inject(HttpClient);\n  private readonly tokens = inject(TokenStorageService);\n  private readonly baseUrl = environment.apiBaseUrl;\n\n  readonly user = signal<AuthUser | null>(null);\n  readonly isAuthenticated = computed(() => !!this.user());\n  readonly loading = signal<boolean>(false);\n  readonly error = signal<string | null>(null);\n\n  // Queue system for concurrent login requests\n  private loginQueue: QueuedRequest[] = [];\n  private isLoginInProgress = false;\n\n  constructor() {\n    this.initializeFromToken();\n  }\n\n  private initializeFromToken(): void {\n    const token = this.tokens.get();\n    if (token && !this.tokens.isExpired(token)) {\n      const payload = this.tokens.parsePayload(token);\n      if (payload && this.isValidPayload(payload)) {\n        this.user.set({\n          id: payload.sub,\n          email: payload.email,\n          firstName: payload.firstName,\n          lastName: payload.lastName,\n          roles: payload.roles || [],\n          exp: payload.exp\n        });\n      } else {\n        this.tokens.clear();\n      }\n    } else {\n      this.tokens.clear();\n    }\n  }\n\n  private isValidPayload(payload: any): payload is DevJwtPayload {\n    return payload && payload.sub && payload.email && payload.exp;\n  }\n\n  signIn(credentials: SignInInput): Observable<JwtAuthResponse> {\n    return defer(() => {\n      // If a login is already in progress, queue this request\n      if (this.isLoginInProgress) {\n        return new Observable<JwtAuthResponse>(subscriber => {\n          this.loginQueue.push({\n            credentials,\n            resolve: (response) => {\n              subscriber.next(response);\n              subscriber.complete();\n            },\n            reject: (error) => {\n              subscriber.error(error);\n            }\n          });\n        });\n      }\n\n      // Execute login immediately if no other login is in progress\n      return this.executeLogin(credentials);\n    });\n  }\n\n  private executeLogin(credentials: SignInInput): Observable<JwtAuthResponse> {\n    this.isLoginInProgress = true;\n    this.loading.set(true);\n    this.error.set(null);\n\n    const loginUrl = `${this.baseUrl}/auth/login`;\n    const headers = new HttpHeaders({\n      'Content-Type': 'application/json'\n    });\n\n    return this.http.post<JwtAuthResponse>(loginUrl, credentials, { headers })\n      .pipe(\n        map(response => {\n          this.handleAuthResponse(response);\n          this.processLoginQueue(response, null);\n          return response;\n        }),\n        catchError(error => {\n          this.handleAuthError(error);\n          this.processLoginQueue(null, error);\n          return throwError(() => error);\n        })\n      );\n  }\n\n  private processLoginQueue(response: JwtAuthResponse | null, error: any): void {\n    this.isLoginInProgress = false;\n    \n    // Process all queued requests with the same result\n    const queue = [...this.loginQueue];\n    this.loginQueue = [];\n    \n    queue.forEach(queuedRequest => {\n      if (response) {\n        queuedRequest.resolve(response);\n      } else if (error) {\n        queuedRequest.reject(error);\n      }\n    });\n  }\n\n  signUp(userData: SignUpInput): Observable<JwtAuthResponse> {\n    this.loading.set(true);\n    this.error.set(null);\n\n    const headers = new HttpHeaders({\n      'Content-Type': 'application/json'\n    });\n\n    return this.http.post<JwtAuthResponse>(`${this.baseUrl}/auth/register`, userData, { headers })\n      .pipe(\n        map(response => {\n          this.handleAuthResponse(response);\n          return response;\n        }),\n        catchError(error => {\n          this.handleAuthError(error);\n          return throwError(() => error);\n        })\n      );\n  }\n\n  private handleAuthResponse(response: JwtAuthResponse): void {\n    this.loading.set(false);\n    \n    if (response.accessToken) {\n      this.tokens.set(response.accessToken);\n      const payload = this.tokens.parsePayload(response.accessToken);\n      \n      if (payload && this.isValidPayload(payload)) {\n        this.user.set({\n          id: payload.sub,\n          email: payload.email,\n          firstName: payload.firstName,\n          lastName: payload.lastName,\n          roles: payload.roles || [],\n          exp: payload.exp\n        });\n      }\n    }\n  }\n\n  private handleAuthError(error: any): void {\n    this.loading.set(false);\n    \n    let errorMessage = 'Ein Fehler ist aufgetreten';\n    \n    if (error.status === 401) {\n      errorMessage = 'Ungültige Anmeldedaten';\n    } else if (error.status === 409) {\n      errorMessage = 'E-Mail-Adresse bereits registriert';\n    } else if (error.status === 400) {\n      errorMessage = 'Ungültige Eingabedaten';\n    } else if (error.error?.message) {\n      errorMessage = error.error.message;\n    }\n    \n    this.error.set(errorMessage);\n  }\n\n  signOut(): void {\n    // Clear any pending login requests\n    this.clearLoginQueue();\n    this.isLoginInProgress = false;\n    \n    this.tokens.clear();\n    this.user.set(null);\n    this.error.set(null);\n    this.loading.set(false);\n  }\n\n  private clearLoginQueue(): void {\n    const queue = [...this.loginQueue];\n    this.loginQueue = [];\n    \n    // Reject all queued requests since we're signing out\n    queue.forEach(queuedRequest => {\n      queuedRequest.reject(new Error('Login cancelled due to sign out'));\n    });\n  }\n\n  hasRole(role: string): boolean {\n    return !!this.user()?.roles?.includes(role);\n  }\n\n  clearError(): void {\n    this.error.set(null);\n  }\n\n  // Helper method to get authorization headers for API calls\n  getAuthHeaders(): HttpHeaders {\n    const token = this.tokens.get();\n    if (token) {\n      return new HttpHeaders({\n        'Authorization': `Bearer ${token}`,\n        'Content-Type': 'application/json'\n      });\n    }\n    return new HttpHeaders({\n      'Content-Type': 'application/json'\n    });\n  }\n}\n"],
  "mappings": "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",
  "names": []
}
