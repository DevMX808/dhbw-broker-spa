import{a as m}from"./chunk-AJAH6LSW.js";import{g as n,i as d}from"./chunk-GBTQ25J6.js";import{Ba as o,P as p,V as h,f as c,n as a,q as l,rb as f,v as g,y as u}from"./chunk-GMUHQ275.js";var k={production:!1,apiBaseUrl:"https://rocky-atoll-88358-b10b362cee67.herokuapp.com"};var P=(()=>{class r{http=h(d);tokens=h(m);baseUrl=k.apiBaseUrl;user=o(null);isAuthenticated=f(()=>!!this.user());loading=o(!1);error=o(null);loginQueue=[];isLoginInProgress=!1;constructor(){this.initializeFromToken()}initializeFromToken(){let t=this.tokens.get();if(t&&!this.tokens.isExpired(t)){let e=this.tokens.parsePayload(t);e&&this.isValidPayload(e)?this.user.set({id:e.sub,email:e.email,firstName:e.firstName,lastName:e.lastName,roles:e.roles||[],exp:e.exp}):this.tokens.clear()}else this.tokens.clear()}isValidPayload(t){return t&&t.sub&&t.email&&t.exp}signIn(t){return g(()=>this.isLoginInProgress?new c(e=>{this.loginQueue.push({credentials:t,resolve:s=>{e.next(s),e.complete()},reject:s=>{e.error(s)}})}):this.executeLogin(t))}executeLogin(t){this.isLoginInProgress=!0,this.loading.set(!0),this.error.set(null);let e=`${this.baseUrl}/auth/login`,s=new n({"Content-Type":"application/json"});return this.http.post(e,t,{headers:s}).pipe(l(i=>(this.handleAuthResponse(i),this.processLoginQueue(i,null),i)),u(i=>(this.handleAuthError(i),this.processLoginQueue(null,i),a(()=>i))))}processLoginQueue(t,e){this.isLoginInProgress=!1;let s=[...this.loginQueue];this.loginQueue=[],s.forEach(i=>{t?i.resolve(t):e&&i.reject(e)})}signUp(t){this.loading.set(!0),this.error.set(null);let e=new n({"Content-Type":"application/json"});return this.http.post(`${this.baseUrl}/auth/register`,t,{headers:e}).pipe(l(s=>(this.handleAuthResponse(s),s)),u(s=>(this.handleAuthError(s),a(()=>s))))}handleAuthResponse(t){if(this.loading.set(!1),t.accessToken){this.tokens.set(t.accessToken);let e=this.tokens.parsePayload(t.accessToken);e&&this.isValidPayload(e)&&this.user.set({id:e.sub,email:e.email,firstName:e.firstName,lastName:e.lastName,roles:e.roles||[],exp:e.exp})}}handleAuthError(t){this.loading.set(!1);let e="Ein Fehler ist aufgetreten";t.status===401?e="Ung\xFCltige Anmeldedaten":t.status===409?e="E-Mail-Adresse bereits registriert":t.status===400?e="Ung\xFCltige Eingabedaten":t.error?.message&&(e=t.error.message),this.error.set(e)}signOut(){this.clearLoginQueue(),this.isLoginInProgress=!1,this.tokens.clear(),this.user.set(null),this.error.set(null),this.loading.set(!1)}clearLoginQueue(){let t=[...this.loginQueue];this.loginQueue=[],t.forEach(e=>{e.reject(new Error("Login cancelled due to sign out"))})}hasRole(t){return!!this.user()?.roles?.includes(t)}clearError(){this.error.set(null)}getAuthHeaders(){let t=this.tokens.get();return t?new n({Authorization:`Bearer ${t}`,"Content-Type":"application/json"}):new n({"Content-Type":"application/json"})}static \u0275fac=function(e){return new(e||r)};static \u0275prov=p({token:r,factory:r.\u0275fac,providedIn:"root"})}return r})();export{P as a};
